<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>EazyCare | ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</title>

  <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{ --brand:#91C65E; --brand-dark:#7DB14F; --ink:#0f172a; --muted:#6b7280; --card:#ffffff; }
    *{box-sizing:border-box;font-family:'Prompt',sans-serif}

    html, body {height:100%;margin:0;overflow-x:hidden;display:flex;flex-direction:column;background:#fff;color:var(--ink);}
    main {flex:1;display:flex;justify-content:center;align-items:center;padding:10px;}
    .wrap {width:100%;max-width:720px;}

    .hero{text-align:center;margin-bottom:20px}
    .header{font-size:2.2rem;font-weight:600;color:#91C65E;line-height:1.0;margin:0 0 4px;text-align:center;}
    .subtext{font-size:15px;font-weight:500;color:#666;margin:0;text-align:center;}

    .card{background:var(--card);border-radius:16px;padding:16px;margin-top:14px;box-shadow:0 6px 24px rgba(2,6,23,.06)}
    .bc-group{display:flex;width:100%}
    .bc-prefix,.bc-tail{font-size:16px;line-height:1.2;padding:.78em 1em;border:0;background:#f9fafb;outline:none;letter-spacing:.14em;flex:1;min-width:0}
    .bc-prefix{flex:0 0 55%;max-width:55%;text-align:center;background:#f3f4f6;color:#6b7280;border-radius:10px 0 0 10px;pointer-events:none;user-select:none}
    .bc-tail{text-align:center;border-radius:0 10px 10px 0}
    .bc-tail:focus{box-shadow:0 0 0 2px rgba(145,198,94,.25)}

    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:14px}
    .btn{font-size:16px;padding:.58em 1.2em;border-radius:50px;border:0;cursor:pointer;flex:1;max-width:100%}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-primary:hover{background:var(--brand-dark)}
    .btn-primary:disabled{opacity:.55;cursor:not-allowed}
    .btn-ghost{background:#f8fafc;color:#666}
    .msg{min-height:1.25em;margin-top:10px;text-align:center}
    .msg.ok{color:#166534}.msg.err{color:#b00020}

    footer{text-align:center;color:#fff;background-color:#91C65E;font-size:12px;padding:12px}
  </style>
</head>
<body>
  <main>
    <div class="wrap">
      <p class="header">REGISTRATION</p>
      <p class="subtext">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Eazy Care</p>

      <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏° -->
      <section class="card" aria-label="‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î">
        <section class="hero">
          <img src="https://www.eazycare.in.th/wp-content/uploads/2025/09/Barcodeexam.jpg"
               alt="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡∏î‡∏π‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î" width="412" height="136" loading="lazy">
          <p class="lead" style="margin:8px 0;color:#666;font-weight:400">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç <strong>3 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</strong> ‡∏Ç‡∏≠‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</p>
        </section>

        <div class="bc-group" role="group" aria-label="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î">
          <input id="bc-prefix" class="bc-prefix" value="8851003738" readonly aria-readonly="true">
          <input id="bc-tail" class="bc-tail" inputmode="numeric" pattern="[0-9]*" maxlength="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô 159" aria-label="3 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢">
        </div>

        <div class="actions"><button id="btn-ok" class="btn btn-primary" disabled>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>
        <div class="actions"><button id="btn-skip" class="btn btn-ghost">‡∏Ç‡πâ‡∏≤‡∏° (‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î)</button></div>

        <p id="bc-msg" class="msg" role="alert" aria-live="polite"></p>
      </section>
    </div>
  </main>

  <footer>¬© 2024 Eazy Care by Boxbillion Co., Ltd. All Rights Reserved.</footer>

  <script>
  (async function(){
    'use strict';
    /* ==================== CONFIG ==================== */
    const LIFF_ID       = '2008100293-1xx32BzA';                 // üîß ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
    const WP_ORIGIN     = 'https://www.eazycare.in.th';           // ‡πÇ‡∏î‡πÄ‡∏°‡∏ô WordPress (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SSO bridge)
    const REGISTER_URL  = WP_ORIGIN + '/‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô/';          // ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° Elementor
    const API_URL       = WP_ORIGIN + '/wp-json/eazycare/v1/product-lookup?code=';

    /* ==================== Helpers ==================== */
    const $ = (s,r=document)=>r.querySelector(s);
    const elPrefix=$('#bc-prefix'), elTail3=$('#bc-tail'), elMsg=$('#bc-msg');
    const btnOk=$('#btn-ok'), btnSkip=$('#btn-skip');
    const BARCODE_PREFIX=elPrefix.value||'8851003738';
    const onlyDigits=v=>(v||'').replace(/\D+/g,'');
    const setMsg=(t,ok)=>{elMsg.className='msg '+(ok?'ok':'err');elMsg.textContent=t||'';};

    function b64urlEncodeJson(obj){
      try{
        const json=JSON.stringify(obj);
        const b64=btoa(encodeURIComponent(json).replace(/%([0-9A-F]{2})/g,(_,p)=>String.fromCharCode('0x'+p)));
        return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
      }catch(_){return ''}
    }

    function buildSsoUrl(idToken, redirUrl){
      const sso = new URL('/wp-admin/admin-post.php', WP_ORIGIN);
      sso.searchParams.set('action','ec_liff_sso');
      sso.searchParams.set('redir', redirUrl);
      if (idToken) sso.searchParams.set('id_token', idToken);
      return sso.toString();
    }

    async function lookup(code13){
      const res=await fetch(API_URL+encodeURIComponent(code13),{method:'GET',mode:'cors',credentials:'omit'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    /* ==================== LIFF Init (get email/id_token) ==================== */
    let ecUser=null, idToken=null;
    try{
      await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
      if(!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return; }
      idToken = (liff.getIDToken && liff.getIDToken()) || '';
      const dec = liff.getDecodedIDToken && liff.getDecodedIDToken();
      ecUser = { email: dec?.email || '' };
    }catch(e){ console.warn('LIFF unavailable', e); }

    /* ==================== Input behaviors ==================== */
    function onInput(){
      let d=onlyDigits(elTail3.value);
      if(d.length>3) d=d.slice(-3);
      elTail3.value=d;
      btnOk.disabled=(d.length!==3);
      setMsg('',true);
    }
    elTail3.addEventListener('input',onInput);
    elTail3.addEventListener('keyup',e=>{if(e.key==='Enter'&&!btnOk.disabled)btnOk.click();});
    onInput();

    /* ==================== Main actions ==================== */
    btnOk.addEventListener('click',async()=>{
      const tail3=onlyDigits(elTail3.value);
      if(tail3.length!==3){setMsg('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 ‡∏´‡∏•‡∏±‡∏Å',false);return;}
      const full13=BARCODE_PREFIX+tail3;
      btnOk.disabled=true;

      const steps=[
        {t:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î...',ms:0},
        {t:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...',ms:1200},
        {t:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...',ms:2400}
      ];
      steps.forEach(s=>setTimeout(()=>setMsg(s.t,true),s.ms));

      try{
        const data=await lookup(full13);
        if(data && data.ok && !data.not_found && data.product_name){
          setTimeout(()=>{setMsg('‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß: '+data.product_name,true);},3600);
          const payload={
            product:{
              product_name:data.product_name,
              category_base:data.category_base||'',
              system:data.system||'',
              category:data.category||''
            },
            ...(ecUser?{user:ecUser}:{})
          };
          const ecp=b64urlEncodeJson(payload);
          const registerUrl=new URL(REGISTER_URL); registerUrl.searchParams.set('ecp',ecp);

          // ‚úÖ ‡πÑ‡∏õ SSO bridge ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ id_token ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ WP ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
          if(idToken){
            const ssoUrl = buildSsoUrl(idToken, registerUrl.toString());
            setTimeout(()=>{ location.href = ssoUrl; }, 4200);
          }else{
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ id_token (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏õ‡∏¥‡∏î‡∏ô‡∏≠‡∏Å LINE) ‡∏Å‡πá‡πÄ‡∏Ç‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏£‡∏á ‡πÜ ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏î‡∏π‡πÅ‡∏•
            setTimeout(()=>{ location.href = registerUrl.toString(); }, 4200);
          }
        }else{
          setTimeout(()=>{setMsg('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î "‡∏Ç‡πâ‡∏≤‡∏°"',false);btnOk.disabled=false;},3200);
        }
      }catch(e){
        console.error(e);
        setTimeout(()=>{setMsg('‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡∏Å‡∏î ‚Äú‡∏Ç‡πâ‡∏≤‡∏°‚Äù',false);btnOk.disabled=false;},3000);
      }
    });

    btnSkip.addEventListener('click',()=>{
      const registerUrl=new URL(REGISTER_URL);
      if(ecUser){ const ecp=b64urlEncodeJson({user:ecUser}); registerUrl.searchParams.set('ecp',ecp); }
      if(idToken){
        const ssoUrl = buildSsoUrl(idToken, registerUrl.toString());
        location.href = ssoUrl;
      }else{
        location.href = registerUrl.toString();
      }
    });
  })();
  </script>
</body>
</html>
