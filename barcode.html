<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="referrer" content="no-referrer" />
  <title>EazyCare | กรอกบาร์โค้ด</title>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{ --ec-green:#91C65E; --ec-green-dark:#7DB14F; --text:#111; --muted:#6b7280; }
    body{font:15px/1.4 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:var(--text); margin:0; background:#fff;}
    #ec-bc-wrap{max-width:560px;margin:24px auto;padding:0 14px;text-align:center}
    .ec-bc-input{margin-bottom:10px}
    .ec-bc-group{display:flex;width:100%;box-sizing:border-box}
    .ec-bc-prefix,.ec-bc-tail{
      font-size:17px;line-height:1.2;padding:.7em 1em;border:1px solid #e5e7eb;outline:none;background:#f9fafb;color:#111;letter-spacing:.15em;box-sizing:border-box
    }
    .ec-bc-prefix{flex:0 0 40%;max-width:180px;text-align:center;border-radius:12px 0 0 12px;background:#f3f4f6;color:#6b7280;border-right:0}
    .ec-bc-tail{flex:1;min-width:0;text-align:center;border-radius:0 12px 12px 0}
    .ec-bc-tail:focus{border-color:var(--ec-green);box-shadow:0 0 0 2px rgba(145,198,94,.25)}
    .ec-actions{display:flex;gap:10px;justify-content:center;margin-top:14px;flex-wrap:wrap}
    .ec-btn{font-size:16px;padding:.75em 1.2em;border-radius:12px;border:0;cursor:pointer;transition:transform .05s,background-color .15s,opacity .15s}
    .ec-btn:active{transform:translateY(1px)}
    .ec-btn-primary{background:var(--ec-green);color:#fff}
    .ec-btn-primary:hover{background:var(--ec-green-dark)}
    .ec-btn-primary:disabled{opacity:.55;cursor:not-allowed}
    .ec-btn-ghost{background:#f9fafb;color:var(--muted);border:1px solid #e5e7eb}
    .ec-msg{min-height:1.2em;margin-top:12px}
    .ec-msg.ok{color:#166534}
    .ec-msg.err{color:#b00020}
  </style>
</head>
<body>
  <div id="ec-bc-wrap">
    <h2 style="margin:8px 0 14px">ตรวจสอบบาร์โค้ดสินค้า</h2>
    <div class="ec-bc-input">
      <div class="ec-bc-group" role="group" aria-label="ใส่รหัสบาร์โค้ด">
        <input id="ec-bc-prefix" class="ec-bc-prefix" value="8851003738" readonly tabindex="-1"
               aria-readonly="true" aria-label="10 หลักแรก" />
        <input id="ec-bc-3" class="ec-bc-tail" inputmode="numeric" pattern="[0-9]*" maxlength="3"
               placeholder="เช่น 159" aria-label="3 หลักสุดท้าย" />
      </div>
    </div>

    <div class="ec-actions">
      <button id="ec-bc-confirm" type="button" class="ec-btn ec-btn-primary" disabled>ยืนยัน</button>
      <button id="ec-bc-skip" type="button" class="ec-btn ec-btn-ghost">ข้าม (ไม่ทราบบาร์โค้ด)</button>
    </div>

    <p id="ec-bc-msg" class="ec-msg" role="alert" aria-live="polite"></p>
  </div>

  <script>
  (async function(){
    'use strict';

    /* ===== CONFIG (แก้เป็นของคุณ) ===== */
    const LIFF_ID      = '2008100293-1xx32BzA';  // LIFF ของ Barcode
    const REGISTER_URL = 'https://www.eazycare.in.th/การรับประกัน/'; // Elementor Form บนโดเมนหลัก
    const API_URL      = 'https://www.eazycare.in.th/wp-json/eazycare/v1/product-lookup?code=';
    const PROXY_URL    = 'https://www.eazycare.in.th/liff-proxy/';    // หน้า proxy ที่ WP (ส่วน B ด้านล่าง)

    /* ===== Helpers ===== */
    const $ = (s,r=document)=>r.querySelector(s);
    const msgEl = $('#ec-bc-msg');
    const setMsg = (t, ok)=>{ msgEl.className='ec-msg ' + (ok?'ok':'err'); msgEl.textContent=t||''; };
    const onlyDigits = v => (v||'').replace(/\D+/g,'');

    // LIFF init
    try { await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true }); }
    catch (e){ console.error('LIFF init error:', e); setMsg('ไม่สามารถเริ่ม LIFF ได้', false); return; }
    if (!liff.isLoggedIn()) { liff.login({ redirectUri: location.href }); return; }

    // Prefill (optional)
    try {
      const profile = await liff.getProfile();
      const decoded = liff.getDecodedIDToken ? liff.getDecodedIDToken() : null;
      const ecUser = {
        lineUserId: profile?.userId||'',
        name:       profile?.displayName||'',
        email:      decoded?.email||'',
        phone:      ''
      };
      sessionStorage.setItem('ecUser', JSON.stringify(ecUser));
    } catch(e){ console.warn('getProfile/getDecodedIDToken failed', e); }

    const elPrefix = $('#ec-bc-prefix');
    const elTail3  = $('#ec-bc-3');
    const btnOk    = $('#ec-bc-confirm');
    const btnSkip  = $('#ec-bc-skip');

    const BARCODE_PREFIX = '8851003738';
    elPrefix.value = BARCODE_PREFIX;

    function onInput(){
      let d = onlyDigits(elTail3.value);
      if (d.length > 3) d = d.slice(-3);
      elTail3.value = d;
      setMsg('', true);
      btnOk.disabled = (d.length !== 3);
    }
    elTail3.addEventListener('input', onInput);
    elTail3.addEventListener('paste', ()=> requestAnimationFrame(onInput));
    elTail3.addEventListener('keyup', e => { if (e.key === 'Enter' && !btnOk.disabled) btnOk.click(); });
    onInput();

    // ----- A) direct call (no cookies/referrer) -----
    async function directFetch(code13){
      const res = await fetch(API_URL + encodeURIComponent(code13), {
        method:'GET',
        mode:'cors',
        credentials:'omit',
        cache:'no-store',
        referrerPolicy:'no-referrer',
        headers:{ 'Accept':'application/json' }
      });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    // ----- C) proxy call via iframe + postMessage -----
    const iframe = document.createElement('iframe');
    iframe.id = 'ec-proxy';
    iframe.src = PROXY_URL;
    iframe.style.display = 'none';
    document.body.appendChild(iframe);

    const PROXY_ORIGIN = new URL(PROXY_URL).origin;
    const NONCE = Math.random().toString(36).slice(2);

    iframe.addEventListener('load', () => {
      iframe.contentWindow.postMessage({ type:'ec-hello', nonce: NONCE }, PROXY_ORIGIN);
    });

    function proxyLookup(code13){
      return new Promise((resolve, reject)=>{
        if (!iframe || !iframe.contentWindow) return reject(new Error('proxy iframe not ready'));
        function onMsg(ev){
          if (ev.origin !== PROXY_ORIGIN) return;
          const m = ev.data || {};
          if (m.type !== 'ec-lookup-res') return;
          window.removeEventListener('message', onMsg);
          if (m.ok) resolve(m.data); else reject(new Error(m.error || 'proxy error'));
        }
        window.addEventListener('message', onMsg);
        iframe.contentWindow.postMessage({ type:'ec-lookup', code: code13, nonce: NONCE }, PROXY_ORIGIN);
      });
    }

    btnOk.addEventListener('click', async ()=>{
      const tail3 = onlyDigits(elTail3.value);
      if (tail3.length !== 3){ setMsg('ต้องกรอกให้ครบ 3 หลัก', false); elTail3.focus(); return; }

      const full13 = BARCODE_PREFIX + tail3;
      setMsg('กำลังตรวจสอบ...', true);
      btnOk.disabled = true;

      try{
        let data;
        try { data = await directFetch(full13); }      // A) ยิงตรงก่อน
        catch(e){ data = await proxyLookup(full13); }  // ถ้าโดนบล็อก → C) proxy

        if (data && data.ok && !data.not_found && data.product_name){
          const ecProduct = {
            product_name:  data.product_name,
            category_base: data.category_base || '',
            system:        data.system || '',
            category:      data.category || ''
          };
          sessionStorage.setItem('ecProduct', JSON.stringify(ecProduct));
          location.href = REGISTER_URL;
        } else {
          setMsg('ไม่พบสินค้าในระบบ กรุณาตรวจสอบเลขอีกครั้ง', false);
          btnOk.disabled = false;
        }
      }catch(e){
        console.error(e);
        setMsg('ระบบไม่พร้อมใช้งาน กรุณาลองใหม่หรือลองกด “ข้าม”', false);
        btnOk.disabled = false;
      }
    });

    btnSkip.addEventListener('click', ()=>{
      sessionStorage.removeItem('ecProduct');
      location.href = REGISTER_URL;
    });
  })();
  </script>
</body>
</html>
