<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="referrer" content="no-referrer" />
  <title>EazyCare | ลงทะเบียนรับประกัน</title>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Google Font: Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --brand:#91C65E; 
      --brand-dark:#7DB14F; 
      --ink:#0f172a; 
      --muted:#6b7280; 
      --bg:#f7faf7;
      --card:#ffffff; 
      --ring:rgba(145,198,94,.35);
    }
    *{box-sizing:border-box}
    body {
      margin:0;
      background: #f5fdf7;
      color:var(--ink);
      font-family: "Prompt", sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }
    .wrap {
      max-width:480px;
      margin:auto;
      padding:24px 18px;
      flex:1;
      display:flex;
      flex-direction:column;
      justify-content:center;
    }

    /* Hero */
    .hero {
      text-align:center;
      margin-bottom:24px;
    }
    .hero h1 {
      font-size:22px;
      margin:0 0 6px;
      font-weight:600;
      color:#111;
    }
    .hero p.lead {
      font-size:18px;
      margin:0 0 16px;
      color:#333;
    }
    .hero img {
      max-width:100%;
      border-radius:12px;
      box-shadow:0 8px 20px rgba(0,0,0,.06);
    }

    /* Card */
    .card {
      background:var(--card);
      border-radius:16px;
      padding:20px;
      box-shadow:0 10px 24px rgba(16,24,40,.08);
      text-align:center;
    }
    .hint {
      font-size:15px;
      color:var(--muted);
      margin:6px 0 16px;
    }

    /* Input */
    .bc-group {
      display:flex;
      width:100%;
      margin-bottom:16px;
    }
    .bc-prefix, .bc-tail {
      font-size:18px; 
      padding:0.9em 1em; 
      border:1px solid #d1d5db;
      outline:none;
    }
    .bc-prefix {
      flex:0 0 45%; 
      max-width:200px; 
      text-align:center; 
      background:#f3f4f6; 
      color:#6b7280;
      border-radius:12px 0 0 12px; 
      border-right:0;
      user-select:none;
    }
    .bc-tail {
      flex:1; 
      text-align:center; 
      border-radius:0 12px 12px 0;
    }
    .bc-tail:focus {
      border-color:var(--brand);
      box-shadow:0 0 0 3px var(--ring);
    }

    /* Buttons */
    .actions {
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .btn {
      flex:1;
      font-size:16px;
      font-weight:500;
      padding:.9em 1.2em;
      border-radius:12px;
      border:0;
      cursor:pointer;
      transition: all .25s ease;
    }
    .btn-primary {
      background:var(--brand);
      color:#fff;
    }
    .btn-primary:hover { background:var(--brand-dark); }
    .btn-primary:disabled { opacity:.55; cursor:not-allowed; }
    .btn-ghost {
      background:#f8fafc; 
      color:#374151; 
      border:1px solid #e5e7eb;
    }
    .btn-ghost:hover { background:#f1f5f9; }

    .msg {
      min-height:1.4em; 
      margin-top:12px; 
      font-size:14px;
    }
    .msg.ok { color:#15803d; }
    .msg.err { color:#dc2626; }

    footer {
      margin:24px auto 12px;
      text-align:center; 
      color:#94a3b8; 
      font-size:13px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- hero -->
    <section class="hero">
      <p class="lead">ลงทะเบียนรับประกันสินค้า</p>
      <h1>กรอกเลข <strong>3 หลักสุดท้าย</strong> ของบาร์โค้ด</h1>
      <p class="hint">ตัวอย่าง: ถ้าบาร์โค้ดขึ้นต้น 8851003738<strong>159</strong> ให้กรอก <strong>159</strong></p>
      <img src="https://www.eazycare.in.th/wp-content/uploads/2025/09/Barcodeexam.jpg"
           alt="ตัวอย่างวิธีดูเลขท้ายบาร์โค้ด" width="400" height="140" loading="lazy">
    </section>

    <!-- card -->
    <section class="card" aria-label="ฟอร์มบาร์โค้ด">
      <div class="bc-group" role="group" aria-label="ใส่รหัสบาร์โค้ด">
        <input id="bc-prefix" class="bc-prefix" value="8851003738" readonly tabindex="-1" aria-readonly="true" aria-label="10 หลักแรก">
        <input id="bc-tail" class="bc-tail" inputmode="numeric" pattern="[0-9]*" maxlength="3" placeholder="เช่น 159" aria-label="3 หลักสุดท้าย">
      </div>
      <div class="actions">
        <button id="btn-ok" class="btn btn-primary" disabled>ยืนยัน</button>
        <button id="btn-skip" class="btn btn-ghost">ข้าม (ไม่ทราบบาร์โค้ด)</button>
      </div>
      <p id="bc-msg" class="msg" role="alert" aria-live="polite"></p>
    </section>

    <footer>© 2025 EazyCare - ดูแลคุณเหมือนคนในครอบครัว</footer>
  </div>

  <!-- ====== JS จากโค้ดเดิมของคุณ (คงไว้ทั้งหมด) ====== -->

  <script>
  (async function(){
    'use strict';

    /* ===== CONFIG (แก้เฉพาะตรงนี้ถ้าจำเป็น) ===== */
    const LIFF_ID      = '2008100293-1xx32BzA';
    const REGISTER_URL = 'https://www.eazycare.in.th/การรับประกัน/';         // หน้าฟอร์ม
    const API_URL      = 'https://www.eazycare.in.th/wp-json/eazycare/v1/product-lookup?code=';
    const PROXY_URL    = 'https://www.eazycare.in.th/liff-proxy/';

    /* ===== Helpers ===== */
    const $ = (s,r=document)=>r.querySelector(s);
    const say = (t,ok)=>{ const el=$('#bc-msg'); el.className='msg ' + (ok?'ok':'err'); el.textContent=t||''; };
    const onlyDigits = v => (v||'').replace(/\D+/g,'');

    // base64url (ข้ามโดเมนด้วย query param)
    function b64urlEncodeJson(obj){
      const json = JSON.stringify(obj);
      const b64  = btoa(encodeURIComponent(json).replace(/%([0-9A-F]{2})/g, (_,p)=>String.fromCharCode('0x'+p)));
      return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }

    // ===== LIFF (เพื่อดึงชื่อ/อีเมล พรีฟิลให้ลูกค้าง่ายขึ้น) =====
    let user = {};
    try{
      await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
      if (!liff.isLoggedIn()) { liff.login({ redirectUri: location.href }); return; }
      const prof = await liff.getProfile();
      const idtk = liff.getDecodedIDToken?.();
      user = {
        lineUserId: prof?.userId || '',
        name: prof?.displayName || '',
        email: idtk?.email || '',
        phone: ''
      };
    }catch(e){
      // ถ้าดึงไม่ได้ ก็ข้ามได้ ไม่กระทบการทำงานหลัก
      console.warn('LIFF profile not available', e);
    }

    // ===== UI bindings =====
    const pf   = $('#bc-prefix');
    const tail = $('#bc-tail');
    const ok   = $('#btn-ok');
    const skip = $('#btn-skip');

    const PREFIX = pf.value || '8851003738';

    function onInput(){
      let d = onlyDigits(tail.value);
      if (d.length > 3) d = d.slice(-3);
      tail.value = d;
      ok.disabled = (d.length !== 3);
      say('', true);
    }
    tail.addEventListener('input', onInput);
    tail.addEventListener('paste', ()=> requestAnimationFrame(onInput));
    tail.addEventListener('keyup', e => { if (e.key === 'Enter' && !ok.disabled) ok.click(); });
    onInput();

    // ===== proxy เตรียมไว้เป็น fallback กรณีโดนบล็อก header/cookie =====
    const ifr = document.createElement('iframe');
    ifr.src = PROXY_URL; ifr.style.display='none'; document.body.appendChild(ifr);
    const PROXY_ORIGIN = new URL(PROXY_URL).origin;
    const NONCE = Math.random().toString(36).slice(2);
    ifr.addEventListener('load', ()=> ifr.contentWindow.postMessage({type:'ec-hello', nonce:NONCE}, PROXY_ORIGIN));
    function proxyLookup(code13){
      return new Promise((resolve,reject)=>{
        function onMsg(ev){
          if (ev.origin!==PROXY_ORIGIN) return;
          const m = ev.data||{}; if (m.type!=='ec-lookup-res') return;
          window.removeEventListener('message', onMsg);
          m.ok ? resolve(m.data) : reject(new Error(m.error||'proxy error'));
        }
        window.addEventListener('message', onMsg);
        ifr.contentWindow.postMessage({type:'ec-lookup', code:code13, nonce:NONCE}, PROXY_ORIGIN);
      });
    }

    // ===== ค้นหา + ส่งต่อแบบข้ามโดเมนด้วย query param =====
    async function lookup(code13){
      try{
        const res = await fetch(API_URL + encodeURIComponent(code13), {
          method:'GET', mode:'cors', credentials:'omit', cache:'no-store', referrerPolicy:'no-referrer',
          headers:{'Accept':'application/json'}
        });
        if (!res.ok) throw new Error('HTTP '+res.status);
        return await res.json();
      }catch(_){
        // fallback ผ่าน proxy
        return await proxyLookup(code13);
      }
    }

    ok.addEventListener('click', async ()=>{
      const d = onlyDigits(tail.value);
      if (d.length!==3){ tail.focus(); say('ต้องกรอกให้ครบ 3 หลัก', false); return; }

      const code13 = PREFIX + d;
      ok.disabled = true; say('กำลังตรวจสอบ...', true);

      try{
        const data = await lookup(code13);
        if (data && data.ok && !data.not_found && data.product_name){
          const payload = {
            product: {
              product_name:  data.product_name,
              category_base: data.category_base || '',
              system:        data.system || '',
              category:      data.category || ''
            },
            user: user
          };
          const ecp = b64urlEncodeJson(payload);
          const url = new URL(REGISTER_URL);
          url.searchParams.set('ecp', ecp);  // <<<<<< ส่งข้ามโดเมน
          location.href = url.toString();
        } else {
          say('ไม่พบสินค้าในระบบ กรุณาตรวจสอบเลขอีกครั้ง', false);
          ok.disabled = false;
        }
      }catch(e){
        console.error(e);
        say('ระบบไม่พร้อมใช้งาน กรุณาลองใหม่หรือลองกด “ข้าม”', false);
        ok.disabled = false;
      }
    });

    skip.addEventListener('click', ()=>{
      const url = new URL(REGISTER_URL);
      // ส่งเฉพาะ user ให้พรีฟิลชื่อ/อีเมล แม้ไม่ทราบรุ่น
      if (user && (user.name || user.email)){
        const ecp = b64urlEncodeJson({user});
        url.searchParams.set('ecp', ecp);
      }
      location.href = url.toString();
    });
  })();
  </script>


</body>
</html>
