<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EazyCare | กำลังเข้าสู่ระบบ…</title>

  <!-- เร่ง DNS/TLS -->
  <link rel="dns-prefetch" href="//static.line-scdn.net">
  <link rel="dns-prefetch" href="//api.line.me">
  <link rel="dns-prefetch" href="//www.eazycare.in.th">
  <link rel="preconnect" href="https://static.line-scdn.net" crossorigin>
  <link rel="preconnect" href="https://api.line.me" crossorigin>
  <link rel="preconnect" href="https://www.eazycare.in.th">

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root { --brand:#91C65E; --muted:#6b7280; }
    *{box-sizing:border-box;font-family:'Prompt',sans-serif}
    body {margin:0; background:#fff; color:#111; display:flex; flex-direction:column; min-height:100vh;}
    main {flex:1; display:flex; align-items:center; justify-content:center; padding:20px;}
    #wrap {max-width:420px;width:100%;text-align:center}

    .logo {width:120px;margin:0 auto 20px;display:block}
    h3 {font-size:22px;font-weight:600;margin:0 0 8px;color:var(--brand)}
    #msg {color:var(--muted);font-size:15px;margin:0 0 16px;min-height:22px}

    .loading {display:flex;justify-content:center;gap:6px;margin:14px auto}
    .dot {width:10px;height:10px;background:var(--brand);border-radius:50%;
      animation:bounce 1.2s infinite ease-in-out;}
    .dot:nth-child(2){animation-delay:0.2s}
    .dot:nth-child(3){animation-delay:0.4s}
    @keyframes bounce {
      0%,80%,100%{transform:scale(0.6);opacity:0.6}
      40%{transform:scale(1);opacity:1}
    }

    footer {text-align:center;color:#fff;background-color:#91C65E;font-size:12px;padding:12px}
  </style>
</head>
<body>
  <main>
    <div id="wrap">
      <img src="https://www.eazycare.in.th/wp-content/uploads/2024/04/cropped-Eazy-Care-1.png"
           alt="EazyCare" class="logo">

      <h3>กำลังเข้าสู่ระบบ…</h3>
      <p id="msg">กรุณารอสักครู่ กำลังเริ่มต้นระบบ</p>

      <div class="loading">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
    </div>
  </main>

  <footer>© 2024 Eazy Care by Boxbillion Co., Ltd. All Rights Reserved.</footer>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
(async function(){
  'use strict';

  const LIFF_ID = "2008100293-QNl6ParD";
  const WP_BASE = "https://www.eazycare.in.th";
  const REDIRECT_PATH = "/check-warranty/";

  const say = t => { const el = document.querySelector('#msg'); if (el) el.textContent = t; };

  // 1) init LIFF
  say("กำลังเชื่อมต่อกับ LINE…");
  await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });

  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: window.location.href });
    return;
  }

  // 2) เอา id_token
  say("กำลังดึงข้อมูลผู้ใช้งาน…");
  const idToken = liff.getIDToken();
  if (!idToken) { say("ไม่พบ id_token"); return; }

  // 3) แสดงข้อความแบบเป็นขั้น ๆ + แผนสำรองถ้าไม่เด้ง
  const target = `${WP_BASE}/wp-admin/admin-post.php`
               + `?action=ec_liff_sso`
               + `&id_token=${encodeURIComponent(idToken)}`
               + `&redir=${encodeURIComponent(REDIRECT_PATH)}`;

  // สร้างปุ่มสำรอง (จะโชว์ถ้ายังไม่ออกจากหน้านี้ในเวลา X วิ)
  const fallbackBtn = document.createElement('a');
  fallbackBtn.href = target;
  fallbackBtn.textContent = "คลิกที่นี่หากระบบยังไม่พาไปต่อ";
  fallbackBtn.style.display = "none";
  fallbackBtn.style.marginTop = "12px";
  fallbackBtn.style.fontSize = "14px";
  document.querySelector('#wrap')?.appendChild(fallbackBtn);

  // แอนิเมชันจุด ๆ เพื่อให้รู้ว่ากำลังทำงาน
  let dot = 0;
  const anim = setInterval(() => {
    dot = (dot + 1) % 4;
    const base = document.querySelector('#msg')?.textContent?.replace(/\.*$/,'') || '';
    say(base + '.'.repeat(dot));
  }, 850);

  // ข้อความขั้นบันได
  const steps = [
    "กำลังเชื่อมต่อระบบเว็บไซต์",
    "กำลังตรวจสอบข้อมูลกับ LINE",
    "กำลังสร้างเซสชันเข้าสู่ระบบ",
    "พร้อมแล้ว… กำลังพาไปยังหน้าข้อมูลประกัน",
    "เข้าสู่ระบบเสร็จสิ้น"
  ];

  // ไล่แสดงข้อความทีละช่วงสั้น ๆ ก่อนเปลี่ยนหน้า
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  for (const s of steps.slice(0, 4)) { // โชว์ 4 ขั้นแรกแบบเร็ว ๆ
    say(s);
    await sleep(850);
  }

  // โชว์ "เข้าสู่ระบบเสร็จสิ้น" สั้น ๆ เพื่อความรู้สึกไม่ค้าง แล้วค่อยเปลี่ยนหน้า
  say(steps[4]);
  await sleep(800);

  // ยิง redirect แบบ top-level
  location.replace(target);



  // ถ้าผู้ใช้กลับมาจากการยกเลิก/ผิดพลาด ให้หยุดแอนิเมชัน
  window.addEventListener('pagehide', () => clearInterval(anim));
})();
</script>


</body>
</html>
