<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EazyCare | กำลังเข้าสู่ระบบ…</title>

  <!-- เร่ง DNS/TLS -->
  <link rel="dns-prefetch" href="//static.line-scdn.net">
  <link rel="dns-prefetch" href="//api.line.me">
  <link rel="dns-prefetch" href="//www.eazycare.in.th">
  <link rel="preconnect" href="https://static.line-scdn.net" crossorigin>
  <link rel="preconnect" href="https://api.line.me" crossorigin>
  <link rel="preconnect" href="https://www.eazycare.in.th">

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --brand:#91C65E;
      --muted:#6b7280;
    }
    *{box-sizing:border-box;font-family:'Prompt',sans-serif}
    body {
      margin:0; background:#fff; color:#111;
      display:flex; align-items:center; justify-content:center;
      min-height:100vh; padding:20px;
    }
    #wrap {max-width:420px;width:100%;text-align:center}
    .logo {width:120px;margin:0 auto 20px;display:block}
    h3 {font-size:22px;font-weight:600;margin:0 0 8px;color:var(--brand)}
    #msg {color:var(--muted);font-size:15px;margin:0 0 16px;min-height:22px}

    .loading {display:flex;justify-content:center;gap:6px;margin:14px auto}
    .dot {
      width:10px;height:10px;background:var(--brand);
      border-radius:50%;animation:bounce 1.2s infinite ease-in-out;
    }
    .dot:nth-child(2){animation-delay:0.2s}
    .dot:nth-child(3){animation-delay:0.4s}
    @keyframes bounce {
      0%,80%,100%{transform:scale(0.6);opacity:0.6}
      40%{transform:scale(1);opacity:1}
    }

    footer{
      text-align:center;
      color:#fff;
      background-color:#91C65E;
      font-size:12px;
      padding:12px;
    }
  </style>
</head>
<body>
  <div id="wrap">
    <img src="https://www.eazycare.in.th/wp-content/uploads/2024/04/cropped-Eazy-Care-1.png"
         alt="EazyCare" class="logo">

    <h3>กำลังเข้าสู่ระบบ…</h3>
    <p id="msg">กรุณารอสักครู่ กำลังเริ่มต้นระบบ</p>

    <div class="loading">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>

      <footer>
    © 2024 Eazy Care by Boxbillion Co., Ltd. All Rights Reserved.
  </footer>
  </div>

<script>
(async function(){
  'use strict';

  const LIFF_ID = '2008100293-QNl6ParD';
  const REDIRECT_PATH = '/check-warranty/';
  const BRIDGE_URL    = 'https://www.eazycare.in.th/wp-admin/admin-post.php?action=ec_liff_sso';

  const $ = s => document.querySelector(s);
  const say = t => { $('#msg').textContent = t; };

  // ข้อความตามลำดับขั้นตอน
  const steps = [
    "กรุณารอสักครู่ กำลังเริ่มต้นระบบ",
    "กำลังเชื่อมต่อกับ LINE...",
    "กำลังดึงข้อมูลผู้ใช้งาน...",
    "กำลังดึงข้อมูลสินค้า...",
    "กำลังดึงข้อมูลระบบประกัน...",
    "กำลังเชื่อมต่อเว็บไซต์ Eazy Care..."
  ];
  let stepIndex = 0;
  const stepTimer = setInterval(()=>{
    stepIndex++;
    if(stepIndex < steps.length){ say(steps[stepIndex]); }
    else { clearInterval(stepTimer); }
  }, 2000); // ทุก 2 วินาที เปลี่ยนข้อความ

  try {
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
  } catch(e){
    say("เริ่ม LIFF ไม่สำเร็จ");
    return;
  }

  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: location.href });
    return;
  }

  const idToken = liff.getIDToken();
  if (!idToken){
    say("ไม่พบ id_token (ตรวจ scope openid)");
    return;
  }

  say("กำลังเข้าสู่ระบบที่เว็บไซต์...");
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = BRIDGE_URL;
  form.target = '_top';
  form.style.display = 'none';

  const f1 = document.createElement('input');
  f1.type = 'hidden';
  f1.name = 'id_token';
  f1.value = idToken;
  form.appendChild(f1);

  const f2 = document.createElement('input');
  f2.type = 'hidden';
  f2.name = 'redirect';
  f2.value = REDIRECT_PATH;
  form.appendChild(f2);

  document.body.appendChild(form);
  form.submit();
})();
</script>

</body>
</html>
