<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EazyCare | กำลังเข้าสู่ระบบ…</title>

  <!-- เร่ง DNS/TLS -->
  <link rel="dns-prefetch" href="//static.line-scdn.net">
  <link rel="dns-prefetch" href="//api.line.me">
  <link rel="dns-prefetch" href="//www.eazycare.in.th">
  <link rel="preconnect" href="https://static.line-scdn.net" crossorigin>
  <link rel="preconnect" href="https://api.line.me" crossorigin>
  <link rel="preconnect" href="https://www.eazycare.in.th">

  <!-- ฟอนต์ -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- LIFF SDK (async; มี fallback โค้ดรอให้เอง) -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js" async></script>

  <style>
    :root { --brand:#91C65E; --muted:#6b7280; }
    *{box-sizing:border-box;font-family:'Prompt',sans-serif}
    body {margin:0; background:#fff; color:#111; display:flex; flex-direction:column; min-height:100vh;}
    main {flex:1; display:flex; align-items:center; justify-content:center; padding:20px;}
    #wrap {max-width:420px;width:100%;text-align:center}
    .logo {width:120px;margin:0 auto 20px;display:block}
    h3 {font-size:22px;font-weight:600;margin:0 0 8px;color:var(--brand)}
    #msg {color:var(--muted);font-size:15px;margin:0 0 16px;min-height:22px}
    .loading {display:flex;justify-content:center;gap:6px;margin:14px auto}
    .dot {width:10px;height:10px;background:var(--brand);border-radius:50%;animation:bounce 1.2s infinite ease-in-out;}
    .dot:nth-child(2){animation-delay:0.2s}
    .dot:nth-child(3){animation-delay:0.4s}
    @keyframes bounce { 0%,80%,100%{transform:scale(0.6);opacity:0.6} 40%{transform:scale(1);opacity:1} }
    footer {text-align:center;color:#fff;background-color:#91C65E;font-size:12px;padding:12px}
  </style>
</head>
<body>
  <main>
    <div id="wrap">
      <img src="https://www.eazycare.in.th/wp-content/uploads/2024/04/cropped-Eazy-Care-1.png" alt="EazyCare" class="logo">
      <h3>กำลังเข้าสู่ระบบ…</h3>
      <p id="msg">กำลังเริ่มต้นระบบ</p>
      <div class="loading" aria-hidden="true"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </div>
  </main>
  <footer>© 2024 Eazy Care by Boxbillion Co., Ltd. All Rights Reserved.</footer>

<script>
/**
 * Ultra-fast LIFF SSO
 * - ข้อความหมุนเวียนเริ่มทันที (ไม่พึ่ง SDK)
 * - ได้ id_token แล้ว → redirect ทันที (ไม่รอ UI)
 * - watchdog ยิงซ้ำป้องกันเบราว์เซอร์นิ่ง
 */
(function(){
  'use strict';

  const LIFF_ID     = "2008100293-QNl6ParD";
  const WP_BASE     = "https://www.eazycare.in.th";
  const REDIRECT_TO = "/check-warranty/";

  const $msg = () => document.getElementById('msg');
  const say  = t => { const el=$msg(); if (el) el.textContent=t; };

  /* 1) ข้อความหมุนเวียน: เริ่มทันที */
  const steps = [
    "กำลังเชื่อมต่อระบบเว็บไซต์",
    "กำลังตรวจสอบข้อมูลกับ LINE",
    "กำลังสร้างเซสชันเข้าสู่ระบบ",
    "เตรียมพาไปยังหน้าข้อมูลประกัน"
  ];
  let step = 0, dots = 0;
  const uiTimer = setInterval(()=>{
    dots = (dots + 1) % 4;
    if (dots === 0) step = (step + 1) % steps.length;
    say(steps[step] + '.'.repeat(dots));
  }, 450);
  const stopUI = ()=>{ try{ clearInterval(uiTimer); }catch(_){} };
  addEventListener('pagehide', stopUI);
  addEventListener('beforeunload', stopUI);

  /* 2) ฟังก์ชัน redirect แบบยิงเผื่อ */
  function jump(url){
    let done=false;
    const go=()=>{ if(!done){ done=true; location.replace(url); } };
    go();                      // ยิงทันที
    setTimeout(go, 200);       // สำรอง
    setTimeout(go, 1200);      // สำรองอีกชั้น
  }

  /* 3) รอให้ LIFF SDK โผล่ (เพราะเรา async) แล้ว init → token → redirect */
  async function bootWithLIFF(){
    // Poll จนกว่าจะมี window.liff (สูงสุด ~3วินาที)
    let tries=0;
    while(!window.liff && tries<60){ await new Promise(r=>setTimeout(r,50)); tries++; }
    if (!window.liff){ say("ไม่สามารถโหลด LIFF ได้"); setTimeout(()=>location.replace(WP_BASE), 1500); return; }

    try{
      await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });

      if (!liff.isLoggedIn()){
        // ให้ LINE จัดการ login แล้วกลับมาหน้านี้
        liff.login({ redirectUri: location.href });
        return;
      }

      // ดึง id_token แบบรวดเร็ว (poll สั้น ๆ เผื่อดีเลย์)
      let token = liff.getIDToken();
      let t=0;
      while(!token && t<20){ await new Promise(r=>setTimeout(r,75)); token = liff.getIDToken(); t++; }
      if (!token){ liff.login({ redirectUri: location.href }); return; }

      // ได้ token แล้ว สร้าง URL แล้ว “พุ่งเลย”
      const target = `${WP_BASE}/wp-admin/admin-post.php?action=ec_liff_sso&id_token=${encodeURIComponent(token)}&redir=${encodeURIComponent(REDIRECT_TO)}`;
      jump(target);

    }catch(err){
      console.error('[LIFF]', err);
      say('เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาลองใหม่…');
      setTimeout(()=>location.replace(WP_BASE), 2000);
    }
  }

  // เริ่มทันทีหลัง DOM พร้อม โดยไม่รอ onload
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bootWithLIFF, {once:true});
  } else {
    bootWithLIFF();
  }
})();
</script>
</body>
</html>
