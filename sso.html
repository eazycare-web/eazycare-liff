<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EazyCare | กำลังเข้าสู่ระบบ…</title>

  <!-- เร่ง DNS/TLS -->
  <link rel="dns-prefetch" href="//static.line-scdn.net">
  <link rel="dns-prefetch" href="//api.line.me">
  <link rel="dns-prefetch" href="//www.eazycare.in.th">
  <link rel="preconnect" href="https://static.line-scdn.net" crossorigin>
  <link rel="preconnect" href="https://api.line.me" crossorigin>
  <link rel="preconnect" href="https://www.eazycare.in.th">

  <!-- ฟอนต์ -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- LIFF SDK โหลดแบบ async (ไม่บล็อกหน้า) -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js" async></script>

  <style>
    :root { --brand:#91C65E; --muted:#6b7280; }
    *{box-sizing:border-box;font-family:'Prompt',sans-serif}
    body {margin:0;background:#fff;color:#111;display:flex;flex-direction:column;min-height:100vh}
    main {flex:1;display:flex;align-items:center;justify-content:center;padding:20px}
    #wrap {max-width:420px;width:100%;text-align:center}
    .logo {width:120px;margin:0 auto 20px;display:block}
    h3 {font-size:22px;font-weight:600;margin:0 0 8px;color:var(--brand)}
    #msg {color:var(--muted);font-size:15px;margin:0 0 16px;min-height:22px}
    .loading {display:flex;justify-content:center;gap:6px;margin:14px auto}
    .dot {width:10px;height:10px;background:var(--brand);border-radius:50%;
      animation:bounce 1.2s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:0.2s}
    .dot:nth-child(3){animation-delay:0.4s}
    @keyframes bounce{0%,80%,100%{transform:scale(.6);opacity:.6}40%{transform:scale(1);opacity:1}}
    footer {text-align:center;color:#fff;background:#91C65E;font-size:12px;padding:12px}
  </style>
</head>
<body>
  <main>
    <div id="wrap">
      <img src="https://www.eazycare.in.th/wp-content/uploads/2024/04/cropped-Eazy-Care-1.png" alt="EazyCare" class="logo">
      <h3>กำลังเข้าสู่ระบบ…</h3>
      <p id="msg">กำลังเริ่มต้นระบบ</p>
      <div class="loading" aria-hidden="true">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
    </div>
  </main>
  <footer>© 2024 Eazy Care by Boxbillion Co., Ltd. All Rights Reserved.</footer>

<script>
(function(){
  'use strict';

  const LIFF_ID     = "2008100293-QNl6ParD";
  const WP_BASE     = "https://www.eazycare.in.th";
  const REDIRECT_TO = "/check-warranty/";

  const $msg = () => document.getElementById('msg');
  const say  = t => { const el = $msg(); if (el) el.textContent = t; };

  /* ---------- ข้อความหมุนเวียน (setInterval ล้วน ๆ ให้ขึ้นแน่ ๆ) ---------- */
  const steps = [
    "กำลังเชื่อมต่อระบบเว็บไซต์",
    "กำลังตรวจสอบข้อมูลกับ LINE",
    "กำลังสร้างเซสชันเข้าสู่ระบบ",
    "เตรียมพาไปยังหน้าข้อมูลประกัน"
  ];
  let stepIdx = 0, dots = 0;
  say(steps[0]); // เริ่มแสดงข้อความแรกทันที

  const dotTimer  = setInterval(()=>{ dots = (dots+1)%4; say(steps[stepIdx] + '.'.repeat(dots)); }, 350);
  const stepTimer = setInterval(()=>{ stepIdx = (stepIdx+1)%steps.length; dots = 0; say(steps[stepIdx]); }, 1200);

  const stopUI = ()=>{ try{ clearInterval(dotTimer); clearInterval(stepTimer); }catch(_){} };
  addEventListener('pagehide', stopUI);
  addEventListener('beforeunload', stopUI);

  /* ---------- redirect helper: ยิงซ้ำกันค้าง ---------- */
  function jump(url){
    let fired = false;
    const go = ()=>{ if(!fired){ fired = true; location.replace(url); } };
    go(); setTimeout(go, 200); setTimeout(go, 900);
  }

  /* ---------- LIFF boot (รอ SDK สูงสุด ~3s, ได้ token ปุ๊บพุ่งทันที) ---------- */
  async function boot(){
    // รอให้ SDK มา
    let wait = 0;
    while (!window.liff && wait < 60) { await new Promise(r=>setTimeout(r,50)); wait++; }
    if (!window.liff) { say("ไม่สามารถโหลด LIFF ได้"); return setTimeout(()=>location.replace(WP_BASE), 1200); }

    try{
      await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });

      if (!liff.isLoggedIn()){
        // กลับเข้าหน้านี้ต่อ flow
        liff.login({ redirectUri: location.href });
        return;
      }

      // บางเครื่อง token มาช้า → รอสั้น ๆ แต่ไม่บล็อก UI
      let idToken = liff.getIDToken();
      let tries = 0;
      while (!idToken && tries < 20) { await new Promise(r=>setTimeout(r,75)); idToken = liff.getIDToken(); tries++; }

      if (!idToken) {
        liff.login({ redirectUri: location.href });
        return;
      }

      const target = `${WP_BASE}/wp-admin/admin-post.php?action=ec_liff_sso`
                   + `&id_token=${encodeURIComponent(idToken)}`
                   + `&redir=${encodeURIComponent(REDIRECT_TO)}`;
      jump(target); // พุ่งเลย ไม่รอข้อความ
    }catch(err){
      console.error('[LIFF]', err);
      say("เกิดข้อผิดพลาดในการเชื่อมต่อ…");
      setTimeout(()=>location.replace(WP_BASE), 1500);
    }
  }

  // เริ่มเร็วที่สุดเท่าที่ DOM พร้อม
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot, { once:true });
  } else {
    boot();
  }
})();
</script>
</body>
</html>
