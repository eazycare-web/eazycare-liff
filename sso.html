<!-- sso.html: ใช้ตัวเดิมของคุณ + เพิ่ม timeout -->
<script>
(async function(){
  'use strict';
  const LIFF_ID      = '2008100293-QNl6ParD';
  const REDIRECT_URL = 'https://www.eazycare.in.th/check-warranty/';
  const PROXY_URL    = 'https://www.eazycare.in.th/liff-proxy/';
  const say = t => document.getElementById('sso-msg').textContent = t;

  try{ await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true }); }
  catch(e){ say('เริ่ม LIFF ไม่สำเร็จ'); return; }
  if (!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return; }

  const idToken = liff.getIDToken();
  if (!idToken){ say('ไม่พบ id_token (ตรวจ scope openid)'); return; }

  const ifr = document.createElement('iframe');
  ifr.src = PROXY_URL; ifr.style.display='none'; document.body.appendChild(ifr);
  const ORI = new URL(PROXY_URL).origin, NONCE = Math.random().toString(36).slice(2);

  await new Promise(res => ifr.addEventListener('load', ()=>{ ifr.contentWindow.postMessage({type:'ec-hello',nonce:NONCE}, ORI); res(); }));

  function proxySSO(tok){
    return new Promise((resolve,reject)=>{
      function onMsg(ev){
        if (ev.origin!==ORI) return;
        const m = ev.data||{};
        if (m.type!=='ec-sso-res') return;
        window.removeEventListener('message', onMsg);
        m.ok ? resolve(m.data) : reject(new Error(m.error||'proxy error'));
      }
      window.addEventListener('message', onMsg);
      ifr.contentWindow.postMessage({type:'ec-sso', id_token:tok, nonce:NONCE}, ORI);
    });
  }

  say('กำลังเชื่อมต่อ...');
  try{
    // ถ้า 8 วิยังไม่ตอบ ให้แสดงคำแนะนำ
    const data = await Promise.race([
      proxySSO(idToken),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), 8000))
    ]);
    if (!data || !data.ok){ say('เข้าสู่ระบบไม่สำเร็จ'); return; }
    location.href = REDIRECT_URL;
  }catch(e){
    console.error(e);
    say('เชื่อมต่อไม่ได้: โปรดตรวจหน้า /liff-proxy/ ว่าไม่ถูก Delay JS / ไม่บล็อก iframe');
  }
})();
</script>
